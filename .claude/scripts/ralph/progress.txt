# Ralph Progress Log
Started: 2024-01-15

## Codebase Patterns
- Migrations: IF NOT EXISTS
- Types: Export from actions.ts
- Tiptap Extensions: Import using named imports from @tiptap/extension-* packages
- React State: Use separate state for HTML content when converting from markdown
- Next.js Imports: Use @/ alias for src/ directory imports
- Tiptap History: Disable StarterKit history and use custom History extension for depth configuration
- Firestore Auto-save: Use debounce with 3s delay, updateDoc with serverTimestamp()
- React Debounce: Use useRef for stable debounced function reference, avoid useCallback

## Key Files
- db/schema.ts
- app/auth/actions.ts
- src/components/Editor/TiptapEditor.tsx
- src/lib/utils/markdownToHtml.ts
- src/app/cotizacion-estructurada/resultado/[id]/page.tsx
---

## 2026-01-25 - US-001
- Implemented base Tiptap editor setup with all required extensions
- Files changed: package.json, src/components/Editor/TiptapEditor.tsx
- **Learnings:**
  - Tiptap extensions must be imported as named imports, not default imports
  - Project uses src/ directory structure for components
  - StarterKit extension provides basic editor functionality
  - Extensions: Table, TableRow, TableCell, TableHeader, TextAlign, Underline
---

## 2026-01-25 - US-002
- Implemented markdownToHtml() function for converting Firestore markdown to HTML for Tiptap
- Files changed: package.json, src/lib/utils/markdownToHtml.ts
- **Learnings:**
  - marked library provides reliable markdown to HTML conversion with GFM support
  - marked.setOptions() accepts gfm: true for table support
  - marked.parse() returns string when called synchronously
  - Function handles edge cases: empty content, special characters (ñ, acentos)
  - Testing confirmed proper structure preservation: headers, tables, lists, bold, italic
  - Utils functions belong in src/lib/utils/ directory
---

## 2026-01-25 - US-003
- Replaced ReactMarkdown with TiptapEditor in resultado page for editable preview
- Files changed: src/app/cotizacion-estructurada/resultado/[id]/page.tsx
- **Learnings:**
  - TiptapEditor component accepts content and onChange props for real-time updates
  - markdownToHtml() converts Firestore markdown to HTML automatically on load
  - Editor container uses sistema de diseño: bg-white border border-gray-200/50 rounded-[16px] shadow-sm
  - State management: separate editorContent state tracks HTML while quotation keeps original markdown
  - Import paths use @/ alias for src/ directory components and utilities
  - Next.js build and lint pass with warnings but no errors
---

## 2026-01-25 - US-004
- Implemented Toolbar component with Bold, Italic, Underline buttons for formatting text
- Files changed: src/components/Editor/Toolbar.tsx, src/components/Editor/TiptapEditor.tsx
- **Learnings:**
  - Tiptap editor commands use `editor.chain().focus().toggleMark('markName').run()` syntax for formatting
  - Button active states checked with `editor.isActive('markName')` for visual feedback
  - Toolbar integrates seamlessly with TiptapEditor by passing editor instance as prop
  - Design system classes: w-10 h-10 border border-gray-200 rounded-lg for icon buttons
  - Active state styling: bg-blue-50 border-blue-600 text-blue-600 
  - Lucide React icons (Bold, Italic, Underline) work well for toolbar buttons
  - Keyboard shortcuts (Cmd+B, Cmd+I, Cmd+U) work automatically with StarterKit and Underline extensions
  - Tooltips added via title attribute for accessibility
---

## 2026-01-25 - US-005
- Implemented HeadingDropdown component with Párrafo, Título 1, Título 2, Título 3 options
- Files changed: src/components/Editor/HeadingDropdown.tsx, src/components/Editor/Toolbar.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap heading detection: `editor.isActive('heading', { level: 1 })` checks for specific heading level
  - Tiptap heading commands: `editor.chain().focus().toggleHeading({ level })` switches to heading level
  - Tiptap paragraph command: `editor.chain().focus().setParagraph()` converts back to paragraph
  - Dropdown state management: useState for isOpen, click outside overlay to close dropdown
  - Design system: rounded-full for dropdown trigger, shadow-2xl rounded-xl p-1.5 for dropdown menu
  - Active state styling: bg-blue-50 text-blue-600 font-medium for current selection
  - ChevronDown icon from Lucide React works well for dropdown indicator
---

## 2026-01-25 - US-006
- Implemented bullet and numbered list buttons in Toolbar with full functionality
- Files changed: src/components/Editor/Toolbar.tsx, src/app/globals.css, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap StarterKit includes BulletList and OrderedList extensions by default
  - List commands: `editor.chain().focus().toggleBulletList().run()` and `editor.chain().focus().toggleOrderedList().run()`
  - List active states: `editor.isActive('bulletList')` and `editor.isActive('orderedList')`
  - Tab/Shift+Tab indentation and Enter navigation work automatically with StarterKit
  - CSS styling: Added .tiptap-editor ul/ol styles in globals.css with text-sm text-gray-700
  - List icons: Lucide React List and ListOrdered icons work well for toolbar buttons
  - Nested list styling: margin control needed for proper indentation appearance
---

## 2026-01-25 - US-007
- Implemented Undo and Redo buttons in Toolbar with keyboard shortcuts and disabled states
- Files changed: src/components/Editor/Toolbar.tsx, src/components/Editor/TiptapEditor.tsx, package.json, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap undo/redo commands: `editor.chain().focus().undo().run()` and `editor.chain().focus().redo().run()`
  - Undo/redo availability check: `editor.can().undo()` and `editor.can().redo()` for disabled state
  - History extension configuration: Install @tiptap/extension-history, disable StarterKit history, configure depth: 100
  - Disabled button styling: disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed 
  - Keyboard shortcuts (Cmd+Z, Cmd+Shift+Z) work automatically with History extension
  - Lucide React icons: Undo2 and Redo2 work well for undo/redo toolbar buttons
  - Extension dependencies: Must install missing Tiptap extensions via npm before using
---

## 2026-01-25 - US-008
- Implemented text alignment buttons (left, center, right, justify) in Toolbar with active state indication
- Files changed: src/components/Editor/Toolbar.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap text alignment commands: `editor.chain().focus().setTextAlign('left|center|right|justify').run()`
  - Text alignment active state: `editor.isActive({ textAlign: 'alignment' })` for specific alignment detection
  - TextAlign extension already included from initial setup in US-001, no additional packages needed
  - Alignment works on paragraphs and headers as specified
  - Lucide React alignment icons: AlignLeft, AlignCenter, AlignRight, AlignJustify work well
  - Active state styling consistent: bg-blue-50 border-blue-600 text-blue-600
  - Tooltips: Spanish text for user-facing interface (Alinear a la izquierda, Centrar texto, etc.)
---

## 2026-01-25 - US-009
- Implemented table cell text editing functionality with full styling and navigation
- Files changed: src/app/globals.css, src/components/Editor/TiptapEditor.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap Table extensions (Table, TableRow, TableCell, TableHeader) provide cell editing by default
  - Table extension resizable: true enables column resizing capabilities
  - CSS styling: table border-gray-200 rounded-xl for design system compliance
  - Header cells: bg-gray-50 text-xs font-semibold uppercase text-gray-500 px-4 py-3
  - Data cells: px-4 py-3 text-gray-600 border-b border-gray-200 text-sm
  - Tab/Shift+Tab navigation works automatically with Tiptap table extensions
  - Click positioning in cells works by default, cursor: text styling improves UX
  - Text formatting (bold, italic, underline) works inside table cells without additional config
  - StarterKit history configuration requires "as any" type assertion to avoid TS errors
---

## 2026-01-25 - US-010
- Implemented table row add/delete functionality with right-click context menu and toolbar button
- Files changed: src/components/Editor/TableContextMenu.tsx, src/components/Editor/TiptapEditor.tsx, src/components/Editor/Toolbar.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap table commands: addRowBefore(), addRowAfter(), deleteRow() methods work seamlessly
  - Context menu positioning: use pageX, pageY for right-click, getBoundingClientRect() for toolbar button
  - React useEffect must be called before any early returns to avoid rules-of-hooks errors
  - Context menu design system: bg-white rounded-xl shadow-2xl p-1.5 border border-gray-200
  - Button interactions: hover:bg-gray-100 for normal actions, hover:bg-red-50 text-red-600 for delete
  - Table detection: editor.isActive('table') checks if cursor is currently in a table
  - Event handling: preventDefault() on right-click, click outside detection with document listener
  - Table toolbar button only appears when editor.isActive('table') is true for better UX
  - Context menu state: useState for isVisible + position coordinates for dynamic positioning
---

## 2026-01-25 - US-011
- Implemented table column add/delete functionality extending existing context menu
- Files changed: src/components/Editor/TableContextMenu.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap table column commands: addColumnBefore(), addColumnAfter(), deleteColumn() work seamlessly
  - Visual separation in context menu: border-t border-gray-100 my-1 divider between row and column operations
  - Column headers editable by default with TableHeader extension, no additional configuration needed
  - Column width auto-adjusts with Table.configure({ resizable: true }) setting
  - Context menu reusability: extending existing menu component better than creating separate menus
  - Consistent interaction patterns: same hover states and icons for similar operations (Plus/Minus)
  - Tiptap automatically maintains table structure and styling when adding/removing columns
  - All table operations (rows + columns) accessible through single unified context menu interface
---

## 2026-01-25 - US-012
- Implemented table creation functionality with visual grid selector for choosing table size
- Files changed: src/components/Editor/TableSizeSelector.tsx, src/components/Editor/Toolbar.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Tiptap table insertion: `editor.chain().focus().insertTable({ rows, cols, withHeaderRow: true })` creates table with header row
  - Grid visualization: Array.from({ length: 36 }, (_, index)) creates 6x6 grid using index math for row/col calculation
  - Dropdown positioning: absolute top-full left-0 mt-1 positions dropdown below button
  - Hover preview: Boolean logic `row <= hoveredCell.row && col <= hoveredCell.col` highlights selected grid area
  - Click outside detection: fixed inset-0 backdrop with z-10 underneath dropdown z-20
  - State management: useState for isOpen and hoveredCell coordinates
  - Grid3X3 icon from Lucide React works well for table creation button
  - Table styling inheritance: New tables automatically use existing .tiptap-editor table CSS rules
---

## 2026-01-25 - US-013
- Implemented auto-save functionality with visual status indicator for document preservation
- Files changed: src/app/cotizacion-estructurada/resultado/[id]/page.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Firestore auto-save: updateDoc with content (HTML) and updatedAt (serverTimestamp()) for proper document versioning
  - Lodash debounce: Already available as dependency, use 3-second delay for optimal UX balance
  - React debounce patterns: useRef.current for stable function reference avoids infinite re-renders vs useCallback
  - Visual feedback states: 'saving' (gray spinner), 'saved' (green checkmark), 'error' (red X) with automatic reset timeouts
  - Save status positioning: Added to header between document title and status badge for clear visibility
  - HTML persistence: Editor HTML content overwrites original markdown in Firestore for edited version preservation
  - Import optimization: Import updateDoc and serverTimestamp from firebase/firestore for Firestore operations
---

## 2026-01-25 - US-014
- Implemented manual save button with Cmd+S keyboard shortcut and visual feedback
- Files changed: src/app/cotizacion-estructurada/resultado/[id]/page.tsx, .claude/scripts/ralph/prd.json
- **Learnings:**
  - Manual save function: Separate state isManualSaving prevents multiple simultaneous save operations
  - Keyboard shortcuts: addEventListener on document for Cmd+S (metaKey || ctrlKey), preventDefault() to avoid browser save dialog
  - Button design system: bg-transparent border border-gray-300 rounded-full px-5 py-2.5 follows btn-secondary styling
  - Visual feedback reuse: Manual save reuses existing saveStatus and getSaveStatusIndicator() for consistency
  - Loading states: Button shows spinner and "Guardando..." text during save operation with disabled state
  - Error handling: Same error handling pattern as auto-save with try/catch and timeout reset
  - Accessibility: title attribute for tooltip showing keyboard shortcut Cmd+S
---